<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown图片提取器 - Web Tools</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 预先应用主题，防止闪烁 -->
    <script>
        // 尽早应用主题以防止闪烁
        (function() {
            try {
                // 简化版的cookie读取函数
                function getCookie(name) {
                    const cookieName = name + "=";
                    const decodedCookie = decodeURIComponent(document.cookie);
                    const cookieArray = decodedCookie.split(';');
                    
                    for (let i = 0; i < cookieArray.length; i++) {
                        let cookie = cookieArray[i];
                        while (cookie.charAt(0) === ' ') {
                            cookie = cookie.substring(1);
                        }
                        if (cookie.indexOf(cookieName) === 0) {
                            return cookie.substring(cookieName.length, cookie.length);
                        }
                    }
                    return null;
                }

                // 添加无过渡效果的类
                document.documentElement.classList.add('no-transition');
                
                const savedTheme = getCookie('web_tools_theme');
                
                if (savedTheme === 'dark') {
                    // 直接应用暗色主题到html元素
                    document.documentElement.style.colorScheme = 'dark';
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else if (savedTheme === 'auto') {
                    // 检查系统主题
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        document.documentElement.style.colorScheme = 'dark';
                        document.documentElement.setAttribute('data-theme', 'dark');
                    }
                }
                
                // 页面加载后移除无过渡效果类
                window.addEventListener('load', function() {
                    setTimeout(function() {
                        document.documentElement.classList.remove('no-transition');
                    }, 100);
                });
            } catch (e) {
                // 出错不处理，让常规流程接管
                console.error('预先应用主题失败：', e);
            }
        })();
    </script>
    <style>
        /* 工具特定样式 */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            margin-bottom: 24px;
            transition: all var(--transition-speed);
            background-color: var(--card-bg);
        }
        
        .upload-area.active {
            border-color: var(--primary-color);
            background-color: rgba(var(--primary-color-rgb), 0.05);
        }
        
        .upload-area i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 16px;
        }
        
        .upload-area h3 {
            margin-bottom: 8px;
        }
        
        .upload-area p {
            margin-bottom: 24px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        .result-area {
            display: none;
            margin-top: 32px;
            padding: 24px;
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
        }
        
        .result-heading {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .result-stat {
            flex: 1;
            min-width: 150px;
            padding: 16px;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .result-stat h4 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .result-stat p {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .result-actions {
            display: flex;
            justify-content: center;
            margin-top: 24px;
        }
        
        .download-btn {
            background: linear-gradient(to right, var(--success-color), #4ade80);
            color: white;
            padding: 12px 36px;
            border-radius: 24px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        .download-btn i {
            font-size: 1.1rem;
        }
        
        .log-area {
            margin-top: 24px;
            max-height: 200px;
            overflow-y: auto;
            padding: 16px;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .log-entry:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .error-msg {
            color: var(--error-color);
        }
        
        .success-msg {
            color: var(--success-color);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        /* 添加响应式设计 */
        @media (max-width: 768px) {
            .upload-area {
                padding: 20px;
            }
            
            .result-stats {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <h1 class="site-title" data-i18n="mdImageExtractor">Markdown图片提取器</h1>
                <p class="site-subtitle" data-i18n="mdImageExtractorDesc">提取Markdown文件中的Base64图片</p>
            </div>
            <div class="settings">
                <div class="theme-toggle">
                    <button id="theme-button" class="icon-button" aria-label="Theme Settings">
                        <i class="fas fa-sun light-icon"></i>
                        <i class="fas fa-moon dark-icon"></i>
                    </button>
                    <div class="theme-menu">
                        <div class="menu-item">
                            <span data-i18n="theme">Theme</span>
                            <label class="switch">
                                <input type="checkbox" id="theme-switch">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="menu-item auto-theme">
                            <span class="switch-label" data-i18n="auto">Auto</span>
                            <label class="switch">
                                <input type="checkbox" id="auto-theme">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <button id="language-button" class="icon-button" aria-label="Language">
                    <i class="fas fa-language"></i>
                    <span class="lang-indicator">EN</span>
                </button>
            </div>
        </header>
        
        <main>
            <div class="back-button">
                <a href="../index.html">
                    <i class="fas fa-arrow-left"></i>
                    <span data-i18n="backToHome">返回首页</span>
                </a>
            </div>

            <div class="tool-content">
                <div class="tool-header">
                    <div class="tool-icon"><i class="fas fa-image"></i></div>
                    <h2 data-i18n="mdImageExtractor">Markdown图片提取器</h2>
                </div>
                <p class="tool-description" data-i18n="mdImageExtractorLongDesc">
                    这个工具可以从Markdown文件中提取Base64编码的图片，将它们转换为JPG图片文件，并打包为ZIP压缩包供下载。
                    非常适合处理包含内嵌图片的Markdown笔记或文档。
                </p>
                
                <!-- 文件上传区域 -->
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-file-upload"></i>
                    <h3 data-i18n="uploadMdFile">上传Markdown文件</h3>
                    <p data-i18n="dragOrClick">拖放文件到这里或点击选择文件</p>
                    <input type="file" id="fileInput" class="file-input" accept=".md, .markdown, .txt">
                    <button class="upload-btn" id="uploadButton" data-i18n="selectFile">选择文件</button>
                </div>
                
                <!-- 结果显示区域 -->
                <div class="result-area" id="resultArea">
                    <div class="result-heading">
                        <h3 data-i18n="extractionResults">处理结果</h3>
                    </div>
                    
                    <div class="result-stats">
                        <div class="result-stat">
                            <h4 data-i18n="totalImages">总图片数</h4>
                            <p id="totalImages">0</p>
                        </div>
                        <div class="result-stat">
                            <h4 data-i18n="extractedImages">已提取图片</h4>
                            <p id="extractedImages">0</p>
                        </div>
                        <div class="result-stat">
                            <h4 data-i18n="zipSize">压缩包大小</h4>
                            <p id="zipSize">0 KB</p>
                        </div>
                    </div>
                    
                    <div class="log-area" id="logArea"></div>
                    
                    <div class="result-actions">
                        <button class="download-btn" id="downloadButton">
                            <span class="loading-spinner hidden" id="downloadSpinner"></span>
                            <i class="fas fa-download"></i>
                            <span data-i18n="downloadZip">下载图片压缩包</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <div class="footer-content">
                <p>&copy; 2023 Web Tools | <span data-i18n="footerDesc">使用便捷的在线工具提高效率</span></p>
                <div class="footer-links">
                    <a href="#" data-i18n="about">关于我们</a>
                    <a href="#" data-i18n="contact">联系我们</a>
                    <a href="#" data-i18n="feedback">意见反馈</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- 引入JSZip库，用于创建和下载ZIP文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script src="../js/cookies.js"></script>
    <script src="../js/theme.js"></script>
    <script src="../js/language.js"></script>
    <script src="../js/main.js"></script>
    
    <!-- 工具特定的脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 页面元素
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadButton = document.getElementById('uploadButton');
            const resultArea = document.getElementById('resultArea');
            const totalImagesEl = document.getElementById('totalImages');
            const extractedImagesEl = document.getElementById('extractedImages');
            const zipSizeEl = document.getElementById('zipSize');
            const logArea = document.getElementById('logArea');
            const downloadButton = document.getElementById('downloadButton');
            const downloadSpinner = document.getElementById('downloadSpinner');
            
            // 全局变量
            let extractedImages = [];
            let zip = null;
            
            // 初始化上传区域事件
            uploadButton.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 文件选择事件
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    processFile(e.target.files[0]);
                }
            });
            
            // 拖放事件
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('active');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('active');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('active');
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.name.endsWith('.md') || file.name.endsWith('.markdown') || file.name.endsWith('.txt')) {
                        processFile(file);
                    } else {
                        addLogEntry('请上传 .md, .markdown 或 .txt 文件', 'error-msg');
                    }
                }
            });
            
            // 下载按钮事件
            downloadButton.addEventListener('click', function() {
                if (zip) {
                    downloadZip();
                }
            });
            
            // 处理上传的文件
            function processFile(file) {
                // 重置
                resultArea.style.display = 'none';
                extractedImages = [];
                logArea.innerHTML = '';
                zip = new JSZip();
                
                addLogEntry(`开始处理文件: ${file.name}`);
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    extractImagesFromMarkdown(content, file.name);
                };
                
                reader.onerror = function() {
                    addLogEntry('读取文件时出错', 'error-msg');
                };
                
                reader.readAsText(file);
            }
            
            // 从Markdown内容中提取图片
            function extractImagesFromMarkdown(content, fileName) {
                // 查找所有base64图片
                const pattern = /\[image\d+\]:\s*<data:image\/([a-z]+);base64,([^>]+)>/g;
                let matches;
                let count = 0;
                
                // 创建一个images文件夹在zip中
                const imagesFolder = zip.folder('images');
                
                // 使用循环查找所有匹配项
                while ((matches = pattern.exec(content)) !== null) {
                    count++;
                    const imageType = matches[1]; // 图片类型 (jpeg, png等)
                    const base64Data = matches[2]; // base64数据
                    
                    try {
                        // 将base64转换为二进制数据
                        const binaryData = atob(base64Data);
                        const array = new Uint8Array(binaryData.length);
                        for (let i = 0; i < binaryData.length; i++) {
                            array[i] = binaryData.charCodeAt(i);
                        }
                        
                        // 创建一个blob对象
                        const blob = new Blob([array], {type: `image/${imageType}`});
                        
                        // 添加到zip
                        imagesFolder.file(`image_${count}.jpg`, blob, {binary: true});
                        
                        // 保存提取的图片信息
                        extractedImages.push({
                            id: count,
                            type: imageType,
                            size: formatSize(blob.size)
                        });
                        
                        addLogEntry(`已提取图片 ${count}: image_${count}.jpg (${formatSize(blob.size)})`);
                    } catch (error) {
                        addLogEntry(`处理图片 ${count} 时出错: ${error.message}`, 'error-msg');
                    }
                }
                
                if (count === 0) {
                    addLogEntry('未在文件中找到base64编码的图片', 'error-msg');
                    return;
                }
                
                // 更新界面
                totalImagesEl.textContent = count;
                extractedImagesEl.textContent = extractedImages.length;
                
                // 生成替换后的markdown
                generateUpdatedMarkdown(content, fileName);
                
                // 显示结果区域
                resultArea.style.display = 'block';
                
                // 生成zip并更新大小
                zip.generateAsync({type: 'blob'})
                    .then(function(blob) {
                        zipSizeEl.textContent = formatSize(blob.size);
                    });
            }
            
            // 生成替换后的markdown文件并添加到zip
            function generateUpdatedMarkdown(content, fileName) {
                let updatedContent = content;
                
                // 替换所有base64图片引用
                extractedImages.forEach(img => {
                    const pattern = new RegExp(`\\[image${img.id}\\]:\\s*<data:image\\/[a-z]+;base64,[^>]+>`, 'g');
                    updatedContent = updatedContent.replace(pattern, `[image${img.id}]: images/image_${img.id}.jpg`);
                });
                
                // 获取文件名（不含扩展名）
                const baseName = fileName.replace(/\.[^/.]+$/, '');
                
                // 添加到zip
                zip.file(`${baseName}_updated.md`, updatedContent);
                
                addLogEntry(`已生成更新后的Markdown文件: ${baseName}_updated.md`);
            }
            
            // 下载zip文件
            function downloadZip() {
                downloadSpinner.classList.remove('hidden');
                downloadButton.disabled = true;
                
                zip.generateAsync({type: 'blob'})
                    .then(function(blob) {
                        saveAs(blob, 'markdown_images.zip');
                        downloadSpinner.classList.add('hidden');
                        downloadButton.disabled = false;
                        addLogEntry('压缩包下载已开始', 'success-msg');
                    })
                    .catch(function(error) {
                        downloadSpinner.classList.add('hidden');
                        downloadButton.disabled = false;
                        addLogEntry(`创建压缩包时出错: ${error.message}`, 'error-msg');
                    });
            }
            
            // 添加日志条目
            function addLogEntry(message, className = '') {
                const entry = document.createElement('div');
                entry.className = `log-entry ${className}`;
                entry.textContent = message;
                logArea.appendChild(entry);
                
                // 自动滚动到底部
                logArea.scrollTop = logArea.scrollHeight;
            }
            
            // 格式化文件大小
            function formatSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html> 